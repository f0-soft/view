View
=====
Осуществляет группу запросов к Flexo для подготовки данных.
Строит персональные конфиги и шаблоны для передачи клиенту.



## Инструкция по установке
* Для запуска требуется установка `nodeunit` через `npm -g i nodeunit`
* Перед запуском провести установку зависимостей `npm install` (требуется `f0.argstype`)
* Для тестов с настоящим `rabbit`, надо ниже закомментировать строку `mock = true;` 
* Перед запуском с настоящим `rabbit` следует очистить коллекции `test` и `test_join` 

### Запуск теста
```
nodeunit test/index.js
```

### Очистка mongo и redis
```
mongo --eval 'db.test.remove(); db.test_join.remove();' && redis-cli FLUSHALL
```



## Схема View
Позволяет определить:
* имя схемы;
* один независимый (корневой) элементы ```flexo```;
* произвольное количество присоединяемых элементов ```flexo```;
* функции предварительной обработки запросов к ```flexo```;
* функции вычисления дополнительных параметров, запускаемые после сбора данных от ```flexo```.



## Запросы к Rabbit
Могут быть двух типов:
* простой запрос - использует любые поля, кроме ```_path```;
* сложный запрос - использует любые поля, обращается к полю ```_path``` через ```$and``` и ```$in```.
Также иногда сложный запрос может обращаться к полям-массивам, отличным от ```_path```, через ```$in```.

```
var mongo_request = { // сложный запрос к mongo
    a: 1
    b: 2
    $and: [
        { _path: { $elemMatch: {
            c: 'k',
            f: 'l',
            i: { $in: [ 'a', 'b' ] }
        }}},
        { _path: { $elemMatch: {
            c: 'p',
            f: 'q',
            o: { $in: [ 'd', 'e' ] }
        }}},
    ]
};

var rabbit_request = [ // сложный запрос к rabbit
    'a', 1,
    'b', 2,
    '$and', [
        [ '_path', [ '$em', [
            'c', 'k',
            'f', 'l',
            'i', [ '$in', 'a', 'b' ]
        ]]],
        [ '_path', [ '$em', [
            'c', 'p',
            'f', 'q',
            'o', [ '$in', 'd', 'e' ]
        ]]]
    ]
];
```



## Шаблон View
Строится на сервере по персональному конфигу.



## init( options, callback )
Выполняет инициализацию модуля

Параметры:
* ```options``` - объект
	* ```provider``` - объект, содержит методы для работы с документами (```find```,```insert```,```modify```,```delete```), иначе говоря, ```flexo```
    * ```views``` - объект, содержит схемы ```View```
    * ```templatePath``` - строка, содержит абсолютный путь к каталогу с шаблонами ```View```
    * ```[templateTimeout]``` - число, время хранения шаблонов в памяти в миллисекундах
* ```callback( error, module )``` - функция
	* ```module``` - объект, контейнер функций 

Пример ```views```
```
var views = {
	'test': { // имя View
		view: require(), // полный объект схемы View
		vids: { // справочник: vid -> ['flexo', 'property', 'depend_field', 'path_name']
		    'q': ['flexo1', 'field1'],
		    'w': ['flexo1', 'field2'],
		    'e': ['flexo2', 'field1', 'field3', 'path1']
		}
	}
}
```



## getTemplate( name, vids, callback )
Выполняет анализ конфига, срез конфига, срез ```viewId```, компоновку шаблона

Параметры:
* ```name``` - строка, название ```View```
* ```ids``` - массив, содержит ```viewId``` разрешенных элементов ```View```
* ```callback ( error, vids, config, template )``` - функция, получает строку шаблона и объект настроек
	* ```vids``` - массив, содержит ```viewId``` элементов ```View``` оставшихся после обработки конфига
	* ```config``` - объект, содержит клиентский конфиг
	* ```template``` - строка, содержит клиентский шаблон



## find( name, vids, request, options, callback )
Производит поиск документов по ```request```.  
Каждый ключ документа - назван по ```viewId``` элемента ```View```.  
Значение каждого ключа объекта - логическое, число, строка, массив или объект.  
Поле ```_link``` - объект. Каждый ключ объекта означает индекс корневого массива.  

__Селектор, отступ, лимит и сортировка возможны только по корневому блоку ```View```.__

Параметры:
* ```name``` - строка, название ```View```
* ```vids``` - массив, содержит ```viewId``` с которыми надо вернуть документы
* ```request``` - объект, запрос пользователя
    * ```selector``` - объект, содержит ключи названий ```view``` от которых идет запрос
        * ```*``` - объект, содержит запрос к ```View```, использующий ```viewId```
    * ```[options]``` - объект,
        * ```[count]``` - логическое, опция запроса количества документов (корней ```View```) удовлетворяющих запросу
        * ```[sort]``` - объект или массив объектов sort, правило сортировки Mongo
        * ```[skip]``` - число, смещение ограничения количества результатов поиска
        * ```[limit]``` - число, ограничение количества результатов поиска
* ```options``` - объект
    * ```insert_user_id``` - логическое, определяет вставлять ли _id пользователя в запрос
    * ```user_id``` - строка, _id пользователя
    * ```role``` - строка, название роли пользователя
* ```callback( error, documents, count )``` - функция
	* ```documents``` - массив, содержит массивы данных из разных коллекций; если документ массива связан с каким-то другим документом, в нем есть поле ```_link```
	    * ```0``` - массив, содержит корневые документы
	        * ```*``` - объект, содержит поля в виде ```viewId```, также может содержать поле ```_link```
	            * ```_link``` - объект, содержит связи с документами из других массивов
	                * ```*``` - массив, содержит номера документов в других масивах
	    * ```0+``` - массив, содержит документы-джойны
	        * ```*``` - объект, содержит поля в виде ```viewId```, также может содержать поле ```_link```
	            * ```_link``` - объект, содержит связи с документами из других массивов
	                * ```*``` - массив, содержит номера документов в других масивах
	* ```count``` - число, общее количество документов удовлетворяющих запросу



## insert( name, vids, request, options, callback )
Производит сохранение документов через соответствующие ```flexo```

Параметры:
* ```name``` - строка, название ```View```
* ```vids``` - массив, содержит ```viewId``` с которыми надо вернуть сохраненные документы (возвращает только корневые элементы)
* ```request``` - массив
	* ```document``` - объект, содержит документ ```View```
* ```options``` - объект
    * ```insert_user_id``` - логическое, определяет вставлять ли _id пользователя в запрос
    * ```user_id``` - строка, _id пользователя
    * ```role``` - строка, название роли пользователя
* ```callback( error, documents )``` - функция
    * ```documents``` - массив
        * ```document``` - объект, содержит поля документа ```View```



## modify( name, request, options, callback )
Производит изменение документов через соответствующие ```flexo```

Параметры:
* ```name``` - строка, название ```View```
* ```request``` - массив
	* ```query``` - объект, содержит запрос на изменение документа
	    * ```selector``` - объект, содержит поля ```_id``` и ```tsUpdate``` в виде ```viewId``` для каждого блока ```Flexo``` если его поле есть в ```properties```
	    * ```properties``` - объект, содержит новые значение полей ```View```
* ```options``` - объект
    * ```insert_user_id``` - логическое, определяет вставлять ли _id пользователя в запрос
    * ```user_id``` - строка, _id пользователя
    * ```role``` - строка, название роли пользователя
* ```callback( error, documents )``` - функция
	* ```documents``` - массив
	    * ```document``` - объект, содержит поля ```_id``` и ```tsUpdate``` в виде ```viewId```



## delete( name, request, options, callback )
Производит удаление документов через соответствующие ```flexo```

Параметры:
* ```name``` - строка, название ```View```
* ```request``` - массив, содержит селекторы на удаление документов
	* ```selector``` - объект, содержит поля ```_id``` и ```tsUpdate``` в виде ```viewId```
* ```options``` - объект
    * ```insert_user_id``` - логическое, определяет вставлять ли _id пользователя в запрос
    * ```user_id``` - строка, _id пользователя
    * ```role``` - строка, название роли пользователя
* ```callback( error, documents )``` - функция
	* ```documents``` - массив
	    * ```document``` - объект, содержит поле ```_id``` в виде ```viewId```
